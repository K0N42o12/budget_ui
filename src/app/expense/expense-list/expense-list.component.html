<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Expenses</ion-title>
    <ion-buttons slot="end">
      <ion-button>
        <ion-icon slot="icon-only" name="person-circle"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Filter Toolbar with Grid Layout -->
  <ion-toolbar>
    <ion-grid>
      <ion-row>
        <!-- Sort Column -->
        <ion-col size="4">
          <ion-item lines="none">
            <ion-icon name="swap-vertical" slot="start"></ion-icon>
            <ion-select
              interface="popover"
              [(ngModel)]="sortBy"
              (ionChange)="onSortChange($event)"
              placeholder="Date (newest first)">
              <ion-select-option value="date,desc">Date (newest first)</ion-select-option>
              <ion-select-option value="date,asc">Date (oldest first)</ion-select-option>
              <ion-select-option value="amount,desc">Amount (highest)</ion-select-option>
              <ion-select-option value="amount,asc">Amount (lowest)</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <!-- Category Column -->
        <ion-col size="4">
          <ion-item lines="none">
            <ion-icon name="pricetag" slot="start"></ion-icon>
            <ion-select
              interface="popover"
              [(ngModel)]="selectedCategoryId"
              (ionChange)="onCategoryChange($event)"
              placeholder="Category">
              <ion-select-option value="">All Categories</ion-select-option>
              @for (category of categories(); track category.id) {
                <ion-select-option [value]="category.id">
                  {{ category.name }}
                </ion-select-option>
              }
            </ion-select>
          </ion-item>
        </ion-col>

        <!-- Search Column -->
        <ion-col size="4">
          <ion-item lines="none" button (click)="toggleSearch()">
            <ion-icon name="search" slot="start"></ion-icon>
            <ion-label>Search</ion-label>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>

  <!-- Expandable Search Bar -->
  @if (showSearch) {
    <ion-toolbar>
      <ion-searchbar
        [(ngModel)]="searchTerm"
        (ionInput)="onSearchInput($event)"
        (ionClear)="onSearchClear()"
        placeholder="Search expenses..."
        [debounce]="300">
      </ion-searchbar>
    </ion-toolbar>
  }
</ion-header>

<ion-content>
  @if (loading()) {
    <ion-list>
      @for (i of [1,2,3,4,5]; track i) {
        <ion-item>
          <ion-skeleton-text [animated]="true" style="width: 100%; height: 60px;"></ion-skeleton-text>
        </ion-item>
      }
    </ion-list>
  }

  @if (!loading()) {
    @for (group of groupedExpenses(); track group.date) {
      <!-- Date Divider with Total -->
      <ion-item-divider>
        <ion-label>{{ group.date }}</ion-label>
        <ion-chip slot="end" color="primary">
          CHF {{ group.total.toFixed(2) }}
        </ion-chip>
      </ion-item-divider>

      <!-- Expense List for this Date -->
      @for (expense of group.expenses; track expense.id) {
        <ion-item button (click)="openExpenseModal(expense)" detail="true">
          <ion-grid style="padding: 0;">
            <ion-row class="ion-align-items-center">
              <!-- Description (left) -->
              <ion-col size="4">
                <ion-label>
                  <h2>{{ expense.description }}</h2>
                </ion-label>
              </ion-col>
              
              <!-- Category Chip (center) -->
              <ion-col size="4" class="ion-text-center">
                <ion-chip>
                  <ion-icon name="pricetag"></ion-icon>
                  <ion-label>{{ getCategoryName(expense.categoryId) }}</ion-label>
                </ion-chip>
              </ion-col>
              
              <!-- Amount (right) -->
              <ion-col size="4" class="ion-text-right">
                <ion-note style="font-size: 16px; font-weight: 500;">
                  CHF {{ expense.amount.toFixed(2) }}
                </ion-note>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-item>
      }
    }
  }

  @if (!loading() && groupedExpenses().length === 0) {
    <div class="ion-padding ion-text-center" style="margin-top: 100px;">
      <ion-icon name="receipt-outline" size="large" color="medium"></ion-icon>
      <h2>No expenses yet</h2>
      <p>Tap the + button to add your first expense</p>
    </div>
  }

  <!-- FAB Button -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="openExpenseModal()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>

<!-- Month Navigator -->
<ion-footer>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="previousMonth()">
        <ion-icon slot="icon-only" name="chevron-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    
    <ion-title class="ion-text-center">
      {{ currentMonthDisplay }}
    </ion-title>
    
    <ion-buttons slot="end">
      <ion-button (click)="nextMonth()">
        <ion-icon slot="icon-only" name="chevron-forward"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>